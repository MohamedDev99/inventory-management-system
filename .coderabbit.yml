# yaml-language-server: $schema=https://coderabbit.ai/integrations/schema.v2.json
# ═══════════════════════════════════════════════════════════════════════════
# CodeRabbit Configuration for MoeWare Inventory Management System
# ═══════════════════════════════════════════════════════════════════════════
# Stack: Spring Boot 4.x (Java 17) · React 18 + TypeScript · PostgreSQL 15
#        Docker · Kubernetes · Terraform · Ansible · GitHub Actions
#
# Schema reference: https://docs.coderabbit.ai/reference/configuration
# Last updated: 2026-02-03
# ═══════════════════════════════════════════════════════════════════════════

# ───────────────────────────────────────────────────────────────────────────
# GENERAL SETTINGS
# ───────────────────────────────────────────────────────────────────────────
language: en-US
early_access: true
enable_free_tier: true

tone_instructions: "Be direct and explain why, not just what. Include code snippets. Treat the author as a capable developer learning DevOps—point out subtle issues without being condescending about simple ones."

# ───────────────────────────────────────────────────────────────────────────
# REVIEWS CONFIGURATION
# ───────────────────────────────────────────────────────────────────────────
reviews:
  # ─── Review profile ───
  profile: assertive # More thorough feedback (suitable for learning project)

  # ─── Workflow automation ───
  request_changes_workflow: false # Manual approval for now
  review_status: true
  review_details: true
  commit_status: true
  fail_commit_status: true

  # ─── Walkthrough & summary ───
  high_level_summary: true
  high_level_summary_placeholder: "@coderabbitai summary"
  high_level_summary_in_walkthrough: false
  collapse_walkthrough: true
  changed_files_summary: true
  sequence_diagrams: true
  estimate_code_review_effort: true
  assess_linked_issues: true
  related_issues: true
  related_prs: true

  # ─── Labeling ───
  suggested_labels: true
  auto_apply_labels: false
  labeling_instructions:
    - label: "backend"
      instructions: "Apply when PR contains changes to Java/Spring Boot code (backend/src/main/java/**)"
    - label: "frontend"
      instructions: "Apply when PR contains changes to React/TypeScript code (frontend/src/**)"
    - label: "database"
      instructions: "Apply when PR contains Flyway migrations or schema changes (backend/src/main/resources/db/migration/**)"
    - label: "docker"
      instructions: "Apply when PR modifies Dockerfiles or docker-compose files"
    - label: "ci-cd"
      instructions: "Apply when PR modifies GitHub Actions workflows (.github/workflows/**)"
    - label: "infrastructure"
      instructions: "Apply when PR contains Terraform or Ansible changes (terraform/**, ansible/**)"
    - label: "kubernetes"
      instructions: "Apply when PR contains K8s manifests or Helm charts (k8s/**)"
    - label: "security"
      instructions: "Apply when PR addresses security vulnerabilities or implements security controls"
    - label: "documentation"
      instructions: "Apply when PR primarily updates documentation (*.md files, excluding code files)"

  # ─── Reviewers ───
  suggested_reviewers: true
  auto_assign_reviewers: false

  # ─── Engagement features ───
  in_progress_fortune: true
  poem: true
  enable_prompt_for_ai_agents: true

  # ─── Auto-title ───
  auto_title_placeholder: "@coderabbitai"
  auto_title_instructions: >
    Generate a concise PR title following Conventional Commits format.
    Use prefixes: feat, fix, ci, iac, config, chore, docs, test, refactor, perf.
    Example: "feat: add inventory transfer endpoint with optimistic locking"

  # ─── File filtering ───
  path_filters:
    # Include all source files
    - "backend/**"
    - "frontend/**"
    - "terraform/**"
    - "ansible/**"
    - "k8s/**"
    - ".github/workflows/**"
    - "docker-compose*.yml"
    - "**/Dockerfile"
    # Exclude generated/build artifacts
    - "!backend/target/**"
    - "!frontend/dist/**"
    - "!frontend/build/**"
    - "!frontend/node_modules/**"
    - "!**/.terraform/**"
    - "!**/terraform.tfstate*"
    - "!**/*.log"
    - "!**/.DS_Store"

  # ─── Path-specific instructions ───
  path_instructions:
    # ══════════════════════════════════════════════════════════════════════
    # BACKEND — Spring Boot
    # ══════════════════════════════════════════════════════════════════════
    - path: "backend/src/main/java/**/entity/**"
      instructions: |
        Entity classes for the 22-table schema. Verify:
        • @Entity and @Table with explicit table names (matching database-schema.md)
        • ID fields use @GeneratedValue(strategy = GenerationType.IDENTITY) with BIGINT
        • Lombok @Data / @Builder / @AllArgsConstructor used consistently
        • @Version field present on entities with concurrent writes (InventoryItem, PurchaseOrder, SalesOrder, StockAdjustment)
        • created_at/updated_at use @CreatedDate/@LastModifiedDate with JPA Auditing
        • Enum columns use @Enumerated(EnumType.STRING), never ORDINAL
        • No field names collide with PostgreSQL reserved words without @Column override
        • Foreign keys match the relationships defined in database-schema.md

    - path: "backend/src/main/resources/db/migration/**"
      instructions: |
        Flyway migrations. Verify:
        • File name: V{N}__{description}.sql (exact format)
        • Tables created in dependency order (no forward FK references)
        • Every FK has explicit ON DELETE and ON UPDATE clauses
        • Indexes created for: all FK columns, columns in WHERE clauses (see database-schema.md sample queries)
        • NO CREATE OR REPLACE on tables (use ALTER or new version)
        • Monetary columns are DECIMAL(12,2), never FLOAT/DOUBLE
        • Enum columns use VARCHAR + CHECK constraint, NOT native PostgreSQL ENUMs
        • Destructive changes (DROP TABLE/COLUMN) should have corresponding undo script (U{N}__)
        • Timestamps use TIMESTAMP NOT NULL DEFAULT NOW()
        • No real PII or production secrets in sample data

    - path: "backend/src/main/java/**/controller/**"
      instructions: |
        REST controllers. Verify:
        • @Operation annotation (Springdoc/OpenAPI) on every endpoint
        • @Valid on request bodies
        • Return DTOs, NEVER raw entities
        • Correct HTTP status codes: 201 (POST), 200 (GET/PUT), 204 (DELETE), 400/404/409/500 (errors)
        • @PreAuthorize for RBAC: ADMIN (all), MANAGER (approve+manage), WAREHOUSE_STAFF (ops), VIEWER (read-only)
        • GlobalExceptionHandler catches all exceptions
        • Endpoints follow RESTful conventions: /api/resources, /api/resources/{id}

    - path: "backend/src/main/java/**/service/**"
      instructions: |
        Service layer (business logic). Verify:
        • @Service annotation
        • @Transactional on methods that modify data
        • Inventory mutations use optimistic locking (@Version) and handle StaleObjectStateException
        • Order number generation (PO-YYYYMMDD-XXXX, SO-YYYYMMDD-XXXX) is thread-safe (synchronized or database sequence)
        • NO direct database access — use @Repository interfaces only
        • Audit log entries created for all CREATE/UPDATE/DELETE on critical entities
        • Validation logic at service layer (not just controller)
        • No business logic in controllers or repositories

    - path: "backend/src/main/java/**/repository/**"
      instructions: |
        Spring Data JPA repositories. Verify:
        • Extends JpaRepository<Entity, Long> or appropriate interface
        • Custom queries use @Query with JPQL (preferred) or native SQL with justification comment
        • Pagination support on list methods: return Page<T> or Slice<T>
        • Method names follow Spring Data conventions (findBy, existsBy, countBy, deleteBy)
        • No business logic here — keep repositories data-access only

    - path: "backend/src/test/**"
      instructions: |
        Tests. Verify:
        • Unit tests mock repositories (no real DB)
        • Integration tests use @SpringBootTest with test profile + Testcontainers PostgreSQL
        • Controller tests use @WebMvcTest
        • At least one test per public service method
        • Migration validation: test applies all migrations to empty schema (smoke test)
        • Test naming: methodName_scenario_expectedBehavior()
        • Use AssertJ for assertions

    # ══════════════════════════════════════════════════════════════════════
    # FRONTEND — React + TypeScript
    # ══════════════════════════════════════════════════════════════════════
    - path: "frontend/src/**"
      instructions: |
        React + TypeScript. Verify:
        • All exports explicitly typed; NO implicit 'any'
        • Presentational components are pure (no side effects)
        • API calls ONLY through /services layer (no direct fetch/axios in components/hooks)
        • Tailwind classes use ONLY design tokens from @theme block: primary-*, accent-*, success-*, warning-*, error-*
        • NO hard-coded hex colors (e.g., #0ea5e9)
        • Use Shadcn/UI for standard components: Button, Input, Table, Dialog, Badge, Select, Textarea, Checkbox, Card, Toast
        • Client-side form validation before any network request
        • React Router v6 patterns

    - path: "frontend/src/services/**"
      instructions: |
        API client layer. Verify:
        • Base URL from environment variable (VITE_API_BASE_URL), never hard-coded
        • Axios interceptors handle: token refresh, 401 logout, global error handling
        • Return types map to TypeScript interfaces in /types
        • Endpoint paths/methods/payloads match backend REST contract
        • Error responses typed properly
        • Consistent HTTP client usage (don't mix fetch and axios)

    - path: "frontend/src/types/**"
      instructions: |
        TypeScript interfaces. Verify:
        • Interfaces mirror backend DTOs 1-to-1 (flag any drift)
        • Status fields use string unions: type OrderStatus = 'PENDING' | 'CONFIRMED' | 'FULFILLED' | 'SHIPPED' | 'DELIVERED' | 'CANCELLED'
        • NO any or unknown without justification
        • Use interface for objects, type for unions/primitives
        • Export all types

    # ══════════════════════════════════════════════════════════════════════
    # DOCKER & CONTAINERS
    # ══════════════════════════════════════════════════════════════════════
    - path: "backend/Dockerfile"
      instructions: |
        Backend container. Verify:
        • Multi-stage: (1) Maven build on full JDK, (2) runtime on eclipse-temurin:17-jre-alpine
        • USER directive (non-root) before ENTRYPOINT
        • HEALTHCHECK instruction present
        • .dockerignore exists in same directory
        • NO secrets in ENV or RUN commands
        • Minimal layers (combine RUN commands)
        • Expose only necessary ports (8080)

    - path: "frontend/Dockerfile"
      instructions: |
        Frontend container. Verify:
        • Multi-stage: (1) Node build, (2) nginx:alpine for serving
        • nginx.conf: gzip enabled, caching headers, SPA fallback (try_files $uri /index.html)
        • Security headers: X-Content-Type-Options, X-Frame-Options, X-XSS-Protection, Referrer-Policy
        • .dockerignore exists
        • NO secrets in build args
        • Minimal final image size

    - path: "docker-compose*.yml"
      instructions: |
        Docker Compose. Verify:
        • ALL image tags pinned (NO :latest in staging/prod files)
        • Explicit networks defined (frontend, backend)
        • PostgreSQL uses named volume for persistence
        • Health checks for database and backend
        • .env file referenced but NOT committed (.env.example committed instead)
        • Service dependencies via depends_on with condition: service_healthy
        • Restart policies appropriate for environment

    # ══════════════════════════════════════════════════════════════════════
    # CI/CD — GitHub Actions
    # ══════════════════════════════════════════════════════════════════════
    - path: ".github/workflows/**"
      instructions: |
        GitHub Actions workflows. Verify:
        • Maven/npm dependency caching configured
        • Docker buildx with layer caching
        • Trivy vulnerability scan BEFORE docker push (fail on CRITICAL/HIGH)
        • Production deploy jobs have environment with protection_rules (manual approval)
        • NO secrets echoed or logged (use ${{ secrets.* }})
        • Branch strategy: CI on push to develop and PRs to main; CD staging on merge to develop; CD prod on merge to main + approval
        • Rollback workflow exists (manual trigger, version/tag input)
        • Test coverage uploaded to Codecov
        • Conventional commit validation on PRs

    # ══════════════════════════════════════════════════════════════════════
    # TERRAFORM — Infrastructure as Code
    # ══════════════════════════════════════════════════════════════════════
    - path: "terraform/**"
      instructions: |
        Terraform IaC. Verify:
        • backend.tf: S3 state + DynamoDB locking
        • ALL resources tagged: Environment, Project, ManagedBy
        • Modules under terraform/modules/; environments call modules only
        • RDS in prod: multi_az=true, storage_encrypted=true, backup_retention_period>=7
        • S3 buckets: versioning enabled, public access blocked, encryption at rest
        • Security groups: restrictive ingress with descriptions
        • NO secrets in .tfvars (use AWS SSM Parameter Store or Vault)
        • Variables validated (type, description, validation block)
        • Outputs for all important resource IDs/ARNs

    # ══════════════════════════════════════════════════════════════════════
    # ANSIBLE — Configuration Management
    # ══════════════════════════════════════════════════════════════════════
    - path: "ansible/**"
      instructions: |
        Ansible configuration. Verify:
        • Every role has meta/main.yml with dependencies
        • Tasks idempotent (guarded by when, creates, changed_when)
        • Secrets via Ansible Vault or external secret store (never plain text in group_vars)
        • Jinja2 templates validated (no undefined variables)
        • become: true only on tasks requiring root
        • Handlers defined for service restarts
        • Dynamic inventory for AWS (aws_ec2 plugin)

    # ══════════════════════════════════════════════════════════════════════
    # KUBERNETES — Orchestration
    # ══════════════════════════════════════════════════════════════════════
    - path: "k8s/**"
      instructions: |
        Kubernetes manifests/Helm. Verify:
        • Every Deployment/StatefulSet has resource requests AND limits (CPU/memory)
        • Liveness and readiness probes defined
        • Pod security context: runAsNonRoot: true, drop ALL capabilities
        • Helm chart: separate values-{env}.yaml per environment
        • Ingress: annotations for SSL termination, rate limiting
        • Secrets NOT as base64 literals (use external-secrets or sealed-secrets)
        • Explicit namespace (NOT default)
        • Labels: app, component, version, environment
        • Health endpoint matches readiness/liveness probe paths

  # ─── Abort on close ───
  abort_on_close: true
  disable_cache: false

  # ─── Auto-review ───
  auto_review:
    enabled: true
    auto_incremental_review: true
    drafts: false # Skip draft PRs
    labels:
      - "!wip"
      - "!draft"
      - "!docs-only"
    ignore_title_keywords:
      - "WIP"
      - "DO NOT REVIEW"
      - "DRAFT"
    base_branches:
      - "develop"
      - "main"

  # ─── Finishing touches ───
  finishing_touches:
    docstrings:
      enabled: true
    unit_tests:
      enabled: true

  # ─── Pre-merge checks ───
  pre_merge_checks:
    # Docstring coverage
    docstrings:
      mode: warning
      threshold: 70

    # PR title validation
    title:
      mode: error
      requirements: >
        Title must follow Conventional Commits format with one of these prefixes:
        feat, fix, ci, iac, config, chore, docs, test, refactor, perf.
        Example: "feat: add JWT refresh token endpoint"

    # PR description check
    description:
      mode: warning

    # Linked issue assessment
    issue_assessment:
      mode: warning

    # Custom security check
    custom_checks:
      - mode: error
        name: "No Hard-coded Secrets"
        instructions: >
          Scan all code for hard-coded credentials, API keys, JWT secrets, database passwords,
          or AWS keys. Flag any literal strings that resemble secrets. All sensitive values
          must come from environment variables, GitHub Secrets, Vault, or AWS SSM.

      - mode: error
        name: "Docker Non-root User"
        instructions: >
          All Dockerfiles must include a USER directive switching to a non-root user before
          the final CMD/ENTRYPOINT. Running containers as root is a security risk.

      - mode: warning
        name: "Migration Undo Scripts"
        instructions: >
          For any Flyway migration that performs destructive operations (DROP TABLE, DROP COLUMN,
          ALTER TABLE DROP), verify a corresponding undo script (U{N}__) exists or is documented
          as not needed with justification.

      - mode: warning
        name: "Test Coverage"
        instructions: >
          For any new service method in backend/src/main/java/**/service/**, verify at least
          one corresponding test exists in backend/src/test/**. Critical methods (inventory
          operations, order processing) should have multiple test cases.

  # ─── Tools integration ───
  tools:
    shellcheck:
      enabled: true
    markdownlint:
      enabled: true
    gitleaks:
      enabled: true
    checkov:
      enabled: true
    eslint:
      enabled: true
    actionlint:
      enabled: true
    hadolint:
      enabled: true
    yamllint:
      enabled: true
    github-checks:
      enabled: true
      timeout_ms: 90000

# ───────────────────────────────────────────────────────────────────────────
# CHAT CONFIGURATION
# ───────────────────────────────────────────────────────────────────────────
chat:
  art: true
  auto_reply: true

# ───────────────────────────────────────────────────────────────────────────
# KNOWLEDGE BASE
# ───────────────────────────────────────────────────────────────────────────
knowledge_base:
  opt_out: false

  # Code guidelines from project docs
  code_guidelines:
    enabled: true
    filePatterns:
      - "**/database-schema.md"
      - "**/IMS_design_guidelines.md"
      - "**/DevOps-Project-Roadmap-IMS.md"
      - "**/.cursorrules"
      - ".github/CONTRIBUTING.md"
      - "**/*.instructions.md"

  # Learnings scope
  learnings:
    scope: auto # Local for public repos, global for private

  # Issues as knowledge
  issues:
    scope: auto

  # Pull requests as knowledge
  pull_requests:
    scope: auto

  # Web search for additional context
  web_search:
    enabled: true

# ───────────────────────────────────────────────────────────────────────────
# CODE GENERATION
# ───────────────────────────────────────────────────────────────────────────
code_generation:
  docstrings:
    language: en-US
    path_instructions:
      - path: "backend/src/main/java/**"
        instructions: >
          Generate JavaDoc comments following Java conventions.
          Include @param, @return, @throws for all public methods.
          Describe business purpose, not implementation details.

      - path: "frontend/src/**"
        instructions: >
          Generate JSDoc comments for TypeScript.
          Include @param and @returns for functions.
          Document component props and their types.

  unit_tests:
    path_instructions:
      - path: "backend/src/main/java/**/service/**"
        instructions: >
          Generate JUnit 5 tests with @SpringBootTest or @ExtendWith(MockitoExtension.class).
          Use AssertJ assertions.
          Mock repository layer.
          Test happy path and error cases.

      - path: "frontend/src/**/*.tsx"
        instructions: >
          Generate React Testing Library tests.
          Use userEvent for interactions.
          Test component behavior, not implementation.
          Mock API calls with MSW.

# ───────────────────────────────────────────────────────────────────────────
# ISSUE ENRICHMENT
# ───────────────────────────────────────────────────────────────────────────
issue_enrichment:
  auto_enrich:
    enabled: false # Can enable later after learning project structure

  planning:
    enabled: true
    auto_planning:
      enabled: true
      labels:
        - "feature"
        - "enhancement"
        - "!wip"

  labeling:
    labeling_instructions:
      - label: "bug"
        instructions: "Unexpected behavior, errors, or defects"
      - label: "feature"
        instructions: "New feature or functionality"
      - label: "enhancement"
        instructions: "Improvement to existing functionality"
      - label: "documentation"
        instructions: "Documentation updates or additions"
      - label: "security"
        instructions: "Security vulnerabilities or improvements"
      - label: "performance"
        instructions: "Performance optimization"
      - label: "refactor"
        instructions: "Code restructuring without behavior change"
    auto_apply_labels: false
